// Catalogo-Pedidos-App.jsx
// React single-file app for a product catalog + ordering + admin-only catalog edits.
// Features:
// - Public catalog: view products, add to cart, place an order (stored in localStorage)
// - Admin area: protected by a password. Admin can add/edit/delete products, upload product images (stored as base64 in localStorage), change product data.
// - Uses localStorage as a lightweight backend (no server required).
// - Tailwind CSS classes used for styling (assumes Tailwind is available in the project).
// How to use:
// 1. Create a React project (e.g., Vite or Create React App). Ensure Tailwind is set up if you want the styling to match.
// 2. Place this file as App.jsx and import into index.js. Or paste into a single-file React sandbox.
// 3. Default admin password is "admin123" (you can change it in localStorage or below). For production, implement a proper backend and authentication.

import React, { useEffect, useState } from "react";

const LS_PRODUCTS = "catalog_products_v1";
const LS_ORDERS = "catalog_orders_v1";
const LS_ADMIN_PASS = "catalog_admin_pass_v1";

// Default sample products
const SAMPLE_PRODUCTS = [
  {
    id: "p1",
    title: "Camiseta Básica",
    price: 12.99,
    description: "Camiseta 100% algodón, varios colores.",
    image: null,
    stock: 20,
  },
  {
    id: "p2",
    title: "Taza Cerámica",
    price: 8.5,
    description: "Taza 350ml con diseño moderno.",
    image: null,
    stock: 50,
  },
];

// Utility: load products from localStorage or initialize
function loadProducts() {
  const raw = localStorage.getItem(LS_PRODUCTS);
  if (!raw) {
    localStorage.setItem(LS_PRODUCTS, JSON.stringify(SAMPLE_PRODUCTS));
    return SAMPLE_PRODUCTS;
  }
  try {
    return JSON.parse(raw);
  } catch (e) {
    console.error("Error parsing products from localStorage", e);
    localStorage.setItem(LS_PRODUCTS, JSON.stringify(SAMPLE_PRODUCTS));
    return SAMPLE_PRODUCTS;
  }
}

function saveProducts(products) {
  localStorage.setItem(LS_PRODUCTS, JSON.stringify(products));
}

function loadOrders() {
  const raw = localStorage.getItem(LS_ORDERS);
  if (!raw) {
    localStorage.setItem(LS_ORDERS, JSON.stringify([]));
    return [];
  }
  try {
    return JSON.parse(raw);
  } catch (e) {
    localStorage.setItem(LS_ORDERS, JSON.stringify([]));
    return [];
  }
}

function saveOrders(orders) {
  localStorage.setItem(LS_ORDERS, JSON.stringify(orders));
}

// Ensure admin password exists
function ensureAdminPassword() {
  const raw = localStorage.getItem(LS_ADMIN_PASS);
  if (!raw) {
    localStorage.setItem(LS_ADMIN_PASS, "admin123");
    return "admin123";
  }
  return raw;
}

export default function App() {
  // Data
  const [products, setProducts] = useState(() => loadProducts());
  const [orders, setOrders] = useState(() => loadOrders());
  const [cart, setCart] = useState([]);

  // UI
  const [query, setQuery] = useState("");
  const [adminMode, setAdminMode] = useState(false);
  const [adminLogged, setAdminLogged] = useState(false);
  const [adminPassInput, setAdminPassInput] = useState("");

  // Admin edit states
  const [editingProduct, setEditingProduct] = useState(null);

  useEffect(() => {
    ensureAdminPassword();
  }, []);

  // Persist products when changed
  useEffect(() => {
    saveProducts(products);
  }, [products]);

  useEffect(() => {
    saveOrders(orders);
  }, [orders]);

  // Cart helpers
  function addToCart(productId, qty = 1) {
    const prod = products.find((p) => p.id === productId);
    if (!prod) return;
    const currentQty = cart.reduce((s, it) => (it.id === productId ? s + it.qty : s), 0);
    if (prod.stock !== null && currentQty + qty > prod.stock) {
      alert("No hay suficiente stock");
      return;
    }
    setCart((c) => {
      const existing = c.find((it) => it.id === productId);
      if (existing) {
        return c.map((it) => (it.id === productId ? { ...it, qty: it.qty + qty } : it));
      }
      return [...c, { id: productId, qty }];
    });
  }

  function removeFromCart(productId) {
    setCart((c) => c.filter((it) => it.id !== productId));
  }

  function updateCartQty(productId, qty) {
    if (qty <= 0) return removeFromCart(productId);
    setCart((c) => c.map((it) => (it.id === productId ? { ...it, qty } : it)));
  }

  function cartTotal() {
    return cart.reduce((sum, it) => {
      const prod = products.find((p) => p.id === it.id);
      return sum + (prod ? prod.price * it.qty : 0);
    }, 0);
  }

  // Checkout (mock): save order to localStorage with buyer info
  function placeOrder(buyer) {
    if (cart.length === 0) {
      alert("El carrito está vacío");
      return;
    }
    // Validate buyer
    if (!buyer || !buyer.name || !buyer.contact) {
      alert("Ingrese nombre y contacto");
      return;
    }

    const order = {
      id: "o_" + Date.now(),
      buyer,
      items: cart.map((it) => ({ ...it })),
      total: cartTotal(),
      createdAt: new Date().toISOString(),
      status: "pending",
    };

    // reduce stock
    const newProducts = products.map((p) => {
      const inCart = cart.find((it) => it.id === p.id);
      if (inCart) {
        return { ...p, stock: p.stock !== null ? p.stock - inCart.qty : p.stock };
      }
      return p;
    });

    setProducts(newProducts);
    setOrders((o) => [order, ...o]);
    setCart([]);
    alert("Pedido realizado. ID: " + order.id);
  }

  // Admin: login
  function adminLogin() {
    const saved = localStorage.getItem(LS_ADMIN_PASS) || "admin123";
    if (adminPassInput === saved) {
      setAdminLogged(true);
      setAdminMode(true);
      setAdminPassInput("");
    } else {
      alert("Contraseña incorrecta");
    }
  }

  function adminLogout() {
    setAdminLogged(false);
    setAdminMode(false);
    setEditingProduct(null);
  }

  // Admin: add or edit product
  function saveProduct(product) {
    if (!product.id) product.id = "p_" + Date.now();
    setProducts((ps) => {
      const exists = ps.find((p) => p.id === product.id);
      if (exists) {
        return ps.map((p) => (p.id === product.id ? product : p));
      }
      return [product, ...ps];
    });
    setEditingProduct(null);
  }

  function deleteProduct(productId) {
    if (!confirm("Eliminar producto?")) return;
    setProducts((ps) => ps.filter((p) => p.id !== productId));
  }

  // Image upload -> base64
  function readFileAsDataURL(file) {
    return new Promise((res, rej) => {
      const reader = new FileReader();
      reader.onload = () => res(reader.result);
      reader.onerror = rej;
      reader.readAsDataURL(file);
    });
  }

  // UI components inside single file for simplicity
  function ProductCard({ p, onAdd }) {
    return (
      <div className="bg-[#fffaf3] rounded p-4 shadow flex flex-col">
        <div className="h-40 flex items-center justify-center mb-3 bg-gray-50 rounded overflow-hidden">
          {p.image ? (
            <img src={p.image} alt={p.title} className="max-h-full object-contain" />
          ) : (
            <div className="text-gray-400">Sin imagen</div>
          )}
        </div>
        <h3 className="font-semibold text-lg">{p.title}</h3>
        <p className="text-sm text-gray-600 flex-1">{p.description}</p>
        <div className="mt-2 flex items-center justify-between">
          <div className="text-xl font-bold">${p.price.toFixed(2)}</div>
          <div>
            <button
              onClick={() => onAdd(p.id)}
              disabled={p.stock === 0}
              className="px-3 py-1 rounded bg-blue-600 text-white disabled:opacity-50"
            >
              Añadir
            </button>
          </div>
        </div>
        <div className="text-xs text-gray-500 mt-1">Stock: {p.stock === null ? "∞" : p.stock}</div>
      </div>
    );
  }

  function AdminPanel() {
    return (
      <div className="space-y-4">
        <div className="flex items-center justify-between">
          <h2 className="text-2xl font-bold">Panel Admin</h2>
          <div>
            <button onClick={adminLogout} className="px-3 py-1 rounded bg-red-500 text-white">Cerrar sesión</button>
          </div>
        </div>

        <div>
          <button
            onClick={() => setEditingProduct({ title: "", price: 0, description: "", image: null, stock: 0 })}
            className="px-3 py-1 rounded bg-green-600 text-white"
          >
            Nuevo producto
          </button>
        </div>

        <div className="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
          {products.map((p) => (
            <div key={p.id} className="border rounded p-3 bg-[#fffaf3]">
              <div className="flex gap-3">
                <div className="w-24 h-24 bg-gray-50 flex items-center justify-center">{p.image ? <img src={p.image} alt="" className="max-h-full" /> : "-"}</div>
                <div className="flex-1">
                  <div className="font-semibold">{p.title}</div>
                  <div className="text-sm text-gray-600">${p.price.toFixed(2)}</div>
                  <div className="text-xs text-gray-500">Stock: {p.stock === null ? "∞" : p.stock}</div>
                </div>
              </div>
              <div className="mt-3 flex gap-2">
                <button onClick={() => setEditingProduct(p)} className="px-2 py-1 rounded bg-yellow-500 text-white">Editar</button>
                <button onClick={() => deleteProduct(p.id)} className="px-2 py-1 rounded bg-red-500 text-white">Eliminar</button>
              </div>
            </div>
          ))}
        </div>

        <div className="mt-4">
          <h3 className="text-xl font-semibold">Pedidos</h3>
          {orders.length === 0 ? (
            <div className="text-sm text-gray-600">No hay pedidos todavía.</div>
          ) : (
            <div className="space-y-3 mt-2">
              {orders.map((o) => (
                <div key={o.id} className="p-3 border rounded bg-[#fffaf3]">
                  <div className="flex justify-between items-start">
                    <div>
                      <div className="font-semibold">Pedido {o.id}</div>
                      <div className="text-sm text-gray-600">{new Date(o.createdAt).toLocaleString()}</div>
                      <div className="text-sm">Comprador: {o.buyer.name} — {o.buyer.contact}</div>
                    </div>
                    <div className="text-right">
                      <div className="font-bold">${o.total.toFixed(2)}</div>
                      <div className="text-xs text-gray-500">{o.status}</div>
                    </div>
                  </div>
                  <div className="mt-2 text-sm">
                    {o.items.map((it) => {
                      const prod = products.find((p) => p.id === it.id);
                      return (
                        <div key={it.id} className="flex items-center gap-3">
                          <div className="w-10 h-10 bg-gray-50 flex items-center justify-center">{prod?.image ? <img src={prod.image} alt="" className="max-h-full" /> : "-"}</div>
                          <div>
                            <div className="font-semibold">{prod?.title || it.id}</div>
                            <div className="text-xs text-gray-600">x{it.qty}</div>
                          </div>
                        </div>
                      );
                    })}
                  </div>
                </div>
              ))}
            </div>
          )}
        </div>
      </div>
    );
  }

  function ProductEditor({ product, onSave, onCancel }) {
    const [title, setTitle] = useState(product?.title || "");
    const [price, setPrice] = useState(product?.price || 0);
    const [desc, setDesc] = useState(product?.description || "");
    const [image, setImage] = useState(product?.image || null);
    const [stock, setStock] = useState(product?.stock ?? 0);

    async function onFile(e) {
      const file = e.target.files?.[0];
      if (!file) return;
      const data = await readFileAsDataURL(file);
      setImage(data);
    }

    function submit() {
      if (!title) return alert("Título requerido");
      onSave({ id: product?.id, title, price: Number(price), description: desc, image, stock: stock === "" ? null : Number(stock) });
    }

    return (
      <div className="fixed inset-0 bg-black/40 flex items-center justify-center p-4">
        <div className="bg-[#fffaf3] rounded p-4 w-full max-w-2xl">
          <h3 className="text-xl font-semibold">{product?.id ? "Editar" : "Nuevo"} producto</h3>
          <div className="grid grid-cols-1 md:grid-cols-2 gap-3 mt-3">
            <div>
              <label className="block text-sm">Título</label>
              <input value={title} onChange={(e) => setTitle(e.target.value)} className="w-full border p-2 rounded" />

              <label className="block text-sm mt-2">Precio</label>
              <input type="number" value={price} onChange={(e) => setPrice(e.target.value)} className="w-full border p-2 rounded" />

              <label className="block text-sm mt-2">Stock (vacío = ilimitado)</label>
              <input value={stock} onChange={(e) => setStock(e.target.value)} className="w-full border p-2 rounded" />
            </div>
            <div>
              <label className="block text-sm">Descripción</label>
              <textarea value={desc} onChange={(e) => setDesc(e.target.value)} className="w-full h-36 border p-2 rounded" />

              <label className="block text-sm mt-2">Imagen</label>
              <input type="file" accept="image/*" onChange={onFile} />
              {image && <div className="mt-2 w-full h-32 bg-gray-50 flex items-center justify-center overflow-hidden"><img src={image} alt="preview" className="max-h-full" /></div>}
            </div>
          </div>

          <div className="mt-4 flex justify-end gap-2">
            <button onClick={onCancel} className="px-3 py-1 rounded bg-gray-300">Cancelar</button>
            <button onClick={submit} className="px-3 py-1 rounded bg-blue-600 text-white">Guardar</button>
          </div>
        </div>
      </div>
    );
  }

  // Public UI
  return (
    <div className="min-h-screen bg-[#f7f2e9] p-6">
      <div className="max-w-6xl mx-auto">
        <header className="flex items-center justify-between mb-6 bg-[#fffaf3] p-3 rounded-xl shadow-sm">
          <div className="flex items-center gap-3">
            <img src="/mnt/data/Copia de Pipia.png" alt="logo" className="w-14 h-14 object-contain" />
            <div>
              <h1 className="text-3xl font-bold text-[#4a3f35]">Pipia Catálogo</h1>
              <div className="text-sm text-[#7a6f67]">Productos y pedidos en línea</div>
            </div>
          </div>
          <div className="flex items-center gap-3">
            <div className="border rounded p-2 bg-[#fffaf3] text-[#4a3f35]">
              <div className="text-sm">Carrito</div>
              <div className="font-semibold">{cart.reduce((s, it) => s + it.qty, 0)} items</div>
            </div>

            {!adminLogged ? (
              <div className="bg-[#fffaf3] p-2 rounded border flex items-center gap-2">
                <input value={adminPassInput} onChange={(e) => setAdminPassInput(e.target.value)} type="password" placeholder="Contraseña admin" className="px-2 py-1 border rounded text-[#4a3f35]" />
                <button onClick={adminLogin} className="px-3 py-1 rounded bg-[#b8a48b] text-white">Entrar admin</button>
              </div>
            ) : (
              <div className="bg-[#fffaf3] p-2 rounded border flex items-center gap-2">
                <button onClick={() => setAdminMode((s) => !s)} className="px-3 py-1 rounded bg-[#a3876a] text-white">{adminMode ? "Ver tienda" : "Panel admin"}</button>
                <button onClick={adminLogout} className="px-3 py-1 rounded bg-[#c56a6a] text-white">Salir</button>
              </div>
            )}
          </div>
        </header>

        {!adminMode ? (
          <main>
            <div className="flex items-center gap-3 mb-4">
              <input placeholder="Buscar..." value={query} onChange={(e) => setQuery(e.target.value)} className="flex-1 p-2 border rounded" />
              <div className="bg-[#fffaf3] p-2 rounded border">
                <div className="font-semibold">Total: ${cartTotal().toFixed(2)}</div>
              </div>
            </div>

            <div className="grid grid-cols-1 md:grid-cols-3 lg:grid-cols-4 gap-4">
              {products
                .filter((p) => p.title.toLowerCase().includes(query.toLowerCase()) || p.description.toLowerCase().includes(query.toLowerCase()))
                .map((p) => (
                  <ProductCard key={p.id} p={p} onAdd={(id) => addToCart(id, 1)} />
                ))}
            </div>

            <div className="mt-6 bg-[#fffaf3] p-4 rounded shadow">
              <h2 className="text-xl font-semibold">Carrito</h2>
              {cart.length === 0 ? (
                <div className="text-sm text-gray-600">El carrito está vacío.</div>
              ) : (
                <div className="space-y-2 mt-2">
                  {cart.map((it) => {
                    const prod = products.find((p) => p.id === it.id);
                    if (!prod) return null;
                    return (
                      <div key={it.id} className="flex items-center justify-between">
                        <div className="flex items-center gap-3">
                          <div className="w-12 h-12 bg-gray-50 flex items-center justify-center">{prod.image ? <img src={prod.image} alt="" className="max-h-full" /> : "-"}</div>
                          <div>
                            <div className="font-semibold">{prod.title}</div>
                            <div className="text-sm text-gray-600">${prod.price.toFixed(2)}</div>
                          </div>
                        </div>
                        <div className="flex items-center gap-2">
                          <input type="number" value={it.qty} onChange={(e) => updateCartQty(it.id, Number(e.target.value))} className="w-16 border p-1 rounded" />
                          <button onClick={() => removeFromCart(it.id)} className="px-2 py-1 rounded bg-red-500 text-white">Quitar</button>
                        </div>
                      </div>
                    );
                  })}

                  <div className="flex justify-between items-center">
                    <div className="font-bold">Total: ${cartTotal().toFixed(2)}</div>
                    <OrderForm onPlace={(buyer) => placeOrder(buyer)} />
                  </div>
                </div>
              )}
            </div>
          </main>
        ) : (
          <AdminPanel />
        )}

        {editingProduct && (
          <ProductEditor
            product={editingProduct}
            onSave={saveProduct}
            onCancel={() => setEditingProduct(null)}
          />
        )}

        <footer className="mt-8 text-center text-sm text-gray-500">App demo — almacena catálogo y pedidos en localStorage.</footer>
      </div>
    </div>
  );
}

function OrderForm({ onPlace }) {
  const [name, setName] = useState("");
  const [contact, setContact] = useState("");

  return (
    <div className="flex items-center gap-2">
      <input placeholder="Nombre" value={name} onChange={(e) => setName(e.target.value)} className="border p-1 rounded" />
      <input placeholder="Contacto (tel/email)" value={contact} onChange={(e) => setContact(e.target.value)} className="border p-1 rounded" />
      <button onClick={() => { onPlace({ name, contact }); setName(""); setContact(""); }} className="px-3 py-1 rounded bg-green-600 text-white">Pagar / Enviar pedido</button>
    </div>
  );
}
